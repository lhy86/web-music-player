<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LHYéŸ³ä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }


.background-cover {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    perspective: 1000px;
}

.background-cover-image {
    width: max(150vh, 150vw);
    height: max(150vh, 150vw);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-size: cover;
    background-position: center;
    filter: blur(max(4vh, 4vw)) brightness(var(--brightness));
    transform-origin: center center;
    animation: slowRotate 120s linear infinite;
}

@keyframes slowRotate {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}


.background-gradient {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4));
    background-size: 400% 400%;
    animation: gradientBG 30s ease infinite;
    transition: all 0.3s;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px var(--shadow-color);
            overflow: hidden;
        }
        
        .player-section {
            flex: 0 0;
            width: 35vw;
            background: var(--player-gradient);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            color: white;
        }
        
        .lyrics-section {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .cover-image {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background-color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cover-placeholder {
            font-size: 40px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .song-info {
            margin-top: 20px;
            text-align: center;
            width: 100%;
        }
        
        .song-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        
        .player-controls {
            width: 100%;
            margin-top: 20px;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--progress-bg);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: white;
            border-radius: 3px;
            width: 0%;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            margin: 0 15px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-button:hover {
            background-color: var(--button-hover);
        }
        
        .play-button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        
        .slider {
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        
        .file-inputs {
            margin-top: 20px;
            width: 100%;
        }
        
        .file-input-container {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }
        
        .file-input-label:hover {
            background-color: var(--button-hover);
        }
        
        .file-input {
            display: none;
        }
        
        .lyrics-container {
            font-size: 18px;
            line-height: 1.8;
            text-align: center; /* æ­Œè¯å±…ä¸­æ˜¾ç¤º */
        }
        
        .lyrics-line {
            padding: 5px 0;
            transition: all 0.5s ease;
            opacity: 0.6;
            color: var(--inactive-lyric-color);
        }
        
        .lyrics-line.active {
            text-shadow: 0 0 8px rgba(255, 255, 255, 1), 
                 0 0 15px rgba(255, 255, 255, 0.7);
            font-size: 22px;
            font-weight: bold;
            opacity: 1;
            color: var(--active-lyric-color);
        }
        
        .no-lyrics {
            color: #888;
            text-align: center;
            margin-top: 40px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .player-section {
                flex: initial;
                width: 100%;
                padding: 20px;
            }
            
            .cover-image {
                width: 180px;
                height: 180px;
            }
        }
        /* æµ…è‰²ä¸»é¢˜ */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --player-gradient: rgba(255, 255, 255, 0.1);
            --active-lyric-color: #ffffff;
            --inactive-lyric-color: #ccc;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-hover: rgba(255, 255, 255, 0.2);
            --progress-bg: rgba(255, 255, 255, 0.3);
            --brightness: 0.5;
            --bg1: #091e33;
            --bg2: #004e5a;
            --bg3: #00365a;
            --bg4: #00243a;
        }

        .controls-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .speed-slider-container {
            padding: 0 15px ;
        }


















        .playlist-item {
    padding: 6px 10px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.remove-song {
    margin-left: 8px;
    width: 18px;
    height: 18px;
    font-size: 12px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.remove-song:hover {
    background-color: rgba(255, 0, 0, 0.5);
}

.song-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

        /* æ·»åŠ åˆ°ç°æœ‰CSSä¸­ */
.playlist-container {
    margin-top: 15px;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
}

.playlist-header {
    padding: 5px 10px;
    font-weight: bold;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.playlist {
    font-size: 14px;
}

.playlist-item {
    padding: 6px 10px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.playlist-item:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.playlist-item.active {
    background-color: rgba(255, 255, 255, 0.25);
    font-weight: bold;
}
/* æ·»åŠ åˆ°æ ·å¼è¡¨ä¸­ */
.file-input-container {
    width: 100%;
    margin-bottom: 10px;
    position: relative;
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    transition: all 0.3s ease;
}

.file-input-label {
    display: block;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}


.file-input-container.drag-over {
    border-color: rgba(255, 255, 255, 0.8);
    background-color: rgba(255, 255, 255, 0.1);
}

.file-input-container.drag-over .file-input-label {
    color: white;
}

    </style>
</head>
<body>
    <div class="background-cover">
        <div class="background-gradient" id="backgroundCover"></div>
    </div>
    
    <div class="container">
        <div class="player-section">
            <div class="cover-image" id="coverImage">
                <div class="cover-placeholder">â™«</div>
            </div>
            
            <div class="song-info">
                <div class="song-title" id="songTitle">æœªåŠ è½½æ­Œæ›²</div>
                <div class="song-artist" id="songArtist">æœªçŸ¥è‰ºæœ¯å®¶</div>
            </div>
            
            <div class="player-controls">
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <div class="time-display">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                
                <div class="control-buttons">
                    <button class="control-button" id="prevButton">â®</button>
                    <button class="control-button play-button" id="playButton">â–¶</button>
                    <button class="control-button" id="nextButton">â­</button>
                </div>
                <div class="controls-container">
                <div class="volume-container">
                    <span class="slider-label">ğŸ”Š</span>
                    <input type="range" class="slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                </div>
                <div class="speed-slider-container">
                    <label for="speedSlider" class="slider-label">é€Ÿåº¦</label>
                    <span id="speedValue" class="speed-value">1.0x</span>
                    <input type="range" id="speedSlider" class="slider" min="0.5" max="2.0" step="0.1" value="1.0">

                </div>
            </div>
            </div>
            
<!-- å°†æ–‡ä»¶å¯¼å…¥åŒºåŸŸæ”¹ä¸ºæ”¯æŒæ‹–æ”¾çš„è®¾è®¡ -->
<div class="file-inputs">
    <div class="file-input-container" id="dropZone">
        <label for="importFile" class="file-input-label">å¯¼å…¥æˆ–æ‹–å…¥éŸ³é¢‘/æ­Œè¯/å°é¢</label>
        <input type="file" id="importFile" class="file-input" accept="audio/*,image/*,text/*,.mp3,.m4a,.wav,.ogg,.flac,.aac,.alac,.wma,.opus,.jpg,.jpeg,.png,.gif,.webp,.lrc,.txt" multiple>
    </div>
</div>


<!-- æ·»åŠ æ’­æ”¾åˆ—è¡¨éƒ¨åˆ† -->
<div class="playlist-container" id="playlistContainer">
    <div class="playlist-header">æ’­æ”¾åˆ—è¡¨</div>
    <div class="playlist" id="playlist"></div>
</div>
        </div>
        <div class="lyrics-section"> <div class="lyrics-container" id="lyricsContainer"> <div class="no-lyrics">è¯·å¯¼å…¥æ­Œè¯æ–‡ä»¶...</div> </div> </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // DOMå…ƒç´ 
    const audioFile = document.getElementById('audioFile');
    const lyricsFile = document.getElementById('lyricsFile');
    const coverImage = document.getElementById('coverImage');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const playButton = document.getElementById('playButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTime = document.getElementById('currentTime');
    const totalTime = document.getElementById('totalTime');
    const volumeSlider = document.getElementById('volumeSlider');
    const lyricsContainer = document.getElementById('lyricsContainer');
    const backgroundCover = document.getElementById('backgroundCover');
    const speedSlider = document.getElementById('speedSlider');
    const speedValue = document.getElementById('speedValue');
    
    // åˆå§‹åŒ–éŸ³é¢‘å’ŒèƒŒæ™¯
    const audio = new Audio();
    audio.volume = volumeSlider.value;
    backgroundCover.className = 'background-gradient';
    
    // åˆå§‹åŒ–æ’­æ”¾é€Ÿåº¦
    speedValue.textContent = speedSlider.value + 'x';
    speedSlider.addEventListener('input', function() {
        speedValue.textContent = this.value + 'x';
        audio.playbackRate = parseFloat(this.value);
    });
    
    // æ­Œè¯æ•°æ®
    let lyrics = [];
    let activeLyricIndex = -1;
    // æ­Œæ›²åˆ—è¡¨ç›¸å…³å˜é‡
    let playlist = [];
    let currentSongIndex = -1;
    const playlistElement = document.getElementById('playlist');
// æ·»åŠ æ‹–æ”¾åŠŸèƒ½
const dropZone = document.getElementById('dropZone');

// é˜»æ­¢é»˜è®¤æ‹–æ”¾è¡Œä¸º
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// æ·»åŠ é«˜äº®æ•ˆæœ
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropZone.classList.add('drag-over');
}

function unhighlight() {
    dropZone.classList.remove('drag-over');
}

// å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    // ä½¿ç”¨ç°æœ‰çš„æ–‡ä»¶å¤„ç†é€»è¾‘å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
    handleFiles(Array.from(files));
}

// ä»ç°æœ‰çš„importFileäº‹ä»¶å¤„ç†å™¨ä¸­æå–æ–‡ä»¶å¤„ç†é€»è¾‘
importFile.addEventListener('change', function() {
    handleFiles(Array.from(this.files));
    this.value = ''; // æ¸…ç©ºinputï¼Œå…è®¸ç”¨æˆ·å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
});

// æ–‡ä»¶å¤„ç†é€»è¾‘æå–ä¸ºå•ç‹¬å‡½æ•°ï¼Œä»¥ä¾¿å¤ç”¨
function handleFiles(files) {
    if (files.length === 0) return;
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å½“å‰æœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²ï¼Œå¯èƒ½æ˜¯åœ¨ä¸ºå½“å‰æ­Œæ›²æ·»åŠ æ­Œè¯æˆ–å°é¢
    if (files.length === 1 && currentSongIndex !== -1) {
        const file = files[0];
        const fileName = file.name.toLowerCase();
        const fileExt = fileName.split('.').pop();
        
        // åˆ¤æ–­æ–‡ä»¶ç±»å‹
        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExt) || 
            file.type.startsWith('image/')) {
            // ä¸ºå½“å‰æ­Œæ›²æ·»åŠ /æ›´æ–°å°é¢
            playlist[currentSongIndex].cover = file;
            processCoverFile(file);
            return;
        } else if (fileExt === 'lrc' || file.type.startsWith('text/') || ['txt'].includes(fileExt)) {
            // ä¸ºå½“å‰æ­Œæ›²æ·»åŠ /æ›´æ–°æ­Œè¯
            playlist[currentSongIndex].lyrics = file;
            detectAndReadEncoding(file);
            return;
        }
        // å¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶åˆ™æŒ‰ç…§æ­£å¸¸æµç¨‹å¤„ç†
    }
    
    // æŒ‰æ–‡ä»¶åå‰ç¼€åˆ†ç»„æ–‡ä»¶ï¼ˆä¸å«æ‰©å±•åçš„éƒ¨åˆ†ï¼‰
    const fileGroups = {};
    
    files.forEach(file => {
        // æå–ä¸å«æ‰©å±•åçš„æ–‡ä»¶åä½œä¸ºæ­Œæ›²ID
        const fileName = file.name;
        const songName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
        
        if (!fileGroups[songName]) {
            fileGroups[songName] = [];
        }
        fileGroups[songName].push(file);
    });
    
    // å¤„ç†æ¯ç»„æ–‡ä»¶
    for (const songName in fileGroups) {
        const songFiles = fileGroups[songName];
        processSongFiles(songName, songFiles);
    }
    
    // æ›´æ–°æ’­æ”¾åˆ—è¡¨UI
    renderPlaylist();
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ æ­Œæ›²ï¼Œè‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¦–
    if (playlist.length > 0 && currentSongIndex === -1) {
        playSong(0);
    }
}

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    
    // è§£æLRCæ ¼å¼æ­Œè¯
    function parseLyrics(text) {
        const lines = text.split('\n');
        const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;
        const metadataRegex = /\[(ti|ar|al|by|offset):(.*?)\]/i;
        const lyrics = [];
        const metadata = {};
        
        for (const line of lines) {
            const trimmedLine = line.trim();
            if (!trimmedLine) continue;
            
            // å¤„ç†å…ƒæ•°æ®
            const metaMatch = trimmedLine.match(metadataRegex);
            if (metaMatch) {
                const [, key, value] = metaMatch;
                metadata[key.toLowerCase()] = value.trim();
                continue;
            }
            
            // å¤„ç†æ­Œè¯æ—¶é—´æ ‡ç­¾
            const timeMatches = [...trimmedLine.matchAll(timeRegex)];
            if (timeMatches.length === 0) {
                // å¤„ç†æ— æ—¶é—´æ ‡ç­¾çš„æ™®é€šæ–‡æœ¬è¡Œ
                if (!trimmedLine.startsWith('[')) {
                    lyrics.push({
                        time: lyrics.length > 0 ? lyrics[lyrics.length - 1].time + 3 : 0,
                        text: trimmedLine
                    });
                }
                continue;
            }
            
            // æå–æ­Œè¯æ–‡æœ¬
            let lyricText = trimmedLine.replace(timeRegex, '').trim();
            
            // å¤„ç†æ¯ä¸ªæ—¶é—´æ ‡ç­¾
            for (const match of timeMatches) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                const milliseconds = parseInt(match[3]) * (match[3].length === 2 ? 10 : 1);
                const time = minutes * 60 + seconds + milliseconds / 1000;
                
                if (lyricText) {
                    lyrics.push({
                        time,
                        text: lyricText
                    });
                }
            }
        }
        
        return {
            lyrics: lyrics.sort((a, b) => a.time - b.time),
            metadata
        };
    }
    
    // æ›´æ–°æ­Œè¯æ˜¾ç¤º
    function updateLyrics(currentTime) {
        const nextLyricIndex = lyrics.findIndex(lyric => lyric.time > currentTime);
        const newActiveIndex = nextLyricIndex === -1 ? lyrics.length - 1 : nextLyricIndex - 1;
        
        if (newActiveIndex !== activeLyricIndex && newActiveIndex >= 0) {
            activeLyricIndex = newActiveIndex;
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.lyrics-line').forEach(line => {
                line.classList.remove('active');
            });
            
            // ç»™å½“å‰æ­Œè¯æ·»åŠ activeç±»
            const activeLine = document.getElementById(`lyric-${activeLyricIndex}`);
            if (activeLine) {
                activeLine.classList.add('active');
                
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                activeLine.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }
    }
    
    // æ¸²æŸ“æ­Œè¯
    function renderLyrics() {
        if (!lyrics || lyrics.length === 0) {
            lyricsContainer.innerHTML = '<div class="no-lyrics">æ²¡æœ‰æ‰¾åˆ°æ­Œè¯æˆ–æ­Œè¯æ ¼å¼ä¸æ­£ç¡®</div>';
            return;
        }
        
        // æ¸…é™¤ç°æœ‰å†…å®¹
        lyricsContainer.innerHTML = '';
        
        lyrics.forEach((lyric, index) => {
            const line = document.createElement('div');
            line.className = 'lyrics-line';
            line.id = `lyric-${index}`;
            line.textContent = lyric.text;
            line.addEventListener('click', () => {
                audio.currentTime = lyric.time;
            });
            lyricsContainer.appendChild(line);
        });
    }
    
    // ä»éŸ³é¢‘æ–‡ä»¶æå–å…ƒæ•°æ®å’Œæ­Œè¯
    function extractMetadata(file) {
        return new Promise((resolve) => {
            if (typeof jsmediatags === 'undefined') {
                console.error('jsmediatagsåº“æœªåŠ è½½');
                resolve({});
                return;
            }
            
            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    console.log('è¯»å–åˆ°çš„ID3æ ‡ç­¾:', tag.tags);
                    
                    // æ›´æ–°æ­Œæ›²ä¿¡æ¯
                    if (tag.tags.title) songTitle.textContent = tag.tags.title;
                    if (tag.tags.artist) songArtist.textContent = tag.tags.artist;
                    
                    // å¤„ç†å°é¢è‰ºæœ¯
                    let coverUrl = null;
                    if (tag.tags.picture) {
                        const { data, format } = tag.tags.picture;
                        let base64String = "";
                        for (let i = 0; i < data.length; i++) {
                            base64String += String.fromCharCode(data[i]);
                        }
                        
                        coverUrl = `data:${format};base64,${window.btoa(base64String)}`;
                        
                        // æ›´æ–°æ’­æ”¾å™¨å°é¢
                        coverImage.innerHTML = ''; // æ¸…é™¤å ä½ç¬¦
                        const img = document.createElement('img');
                        img.src = coverUrl;
                        img.className = 'cover-image';
                        coverImage.appendChild(img);
                        
                        // æ›´æ–°èƒŒæ™¯
                        backgroundCover.className = 'background-cover-image';
                        backgroundCover.style.backgroundImage = `url(${coverUrl})`;
                    } else {
                        // æ²¡æœ‰å°é¢ï¼Œä½¿ç”¨æ¸å˜èƒŒæ™¯
                        backgroundCover.className = 'background-gradient';
                    }
                    
                    // å°è¯•ä»å„ä¸ªå­—æ®µè·å–æ­Œè¯
                    let extractedLyrics = null;
                    
                    // 1. ä»LYRICISTå­—æ®µè·å–æ­Œè¯ (æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œä¸»è¦åœ¨è¿™ä¸ªå­—æ®µ)
                    if (tag.tags.LYRICIST) {
                        console.log('ä»LYRICISTå­—æ®µè·å–æ­Œè¯');
                        extractedLyrics = tag.tags.LYRICIST;
                    } 
                    // 2. ä»lyricistå­—æ®µè·å–æ­Œè¯ (å°å†™å˜ä½“)
                    else if (tag.tags.lyricist) {
                        console.log('ä»lyricistå­—æ®µè·å–æ­Œè¯');
                        extractedLyrics = tag.tags.lyricist;
                    }
                    // 3. ä»unsynchronisedLyricså­—æ®µè·å–æ­Œè¯
                    else if (tag.tags.unsynchronisedLyrics) {
                        console.log('ä»unsynchronisedLyricså­—æ®µè·å–æ­Œè¯');
                        extractedLyrics = tag.tags.unsynchronisedLyrics.text;
                    }
                    // 4. ä»synchronisedLyricså­—æ®µè·å–æ­Œè¯
                    else if (tag.tags.synchronisedLyrics) {
                        console.log('ä»synchronisedLyricså­—æ®µè·å–æ­Œè¯');
                        extractedLyrics = tag.tags.synchronisedLyrics.text;
                    }
                    // 5. ä»lyricså­—æ®µè·å–æ­Œè¯
                    else if (tag.tags.lyrics) {
                        console.log('ä»lyricså­—æ®µè·å–æ­Œè¯');
                        extractedLyrics = tag.tags.lyrics;
                    }
                    
                    // 6. éå†æ‰€æœ‰æ ‡ç­¾å­—æ®µï¼ŒæŸ¥æ‰¾å¯èƒ½åŒ…å«æ­Œè¯çš„å­—æ®µ
                    if (!extractedLyrics) {
                        for (const key in tag.tags) {
                            if (typeof tag.tags[key] === 'string' && 
                                (key.toLowerCase().includes('lyric') || key.toLowerCase().includes('text'))) {
                                console.log(`ä»${key}å­—æ®µè·å–æ­Œè¯`);
                                extractedLyrics = tag.tags[key];
                                break;
                            }
                            // æ£€æŸ¥å¯¹è±¡ç±»å‹å­—æ®µ
                            else if (typeof tag.tags[key] === 'object' && tag.tags[key] && tag.tags[key].text) {
                                console.log(`ä»${key}.textå­—æ®µè·å–æ­Œè¯`);
                                extractedLyrics = tag.tags[key].text;
                                break;
                            }
                        }
                    }
                    
                    if (extractedLyrics) {
                        console.log('æ‰¾åˆ°æ­Œè¯æ•°æ®');
                    } else {
                        console.log('æœªåœ¨éŸ³é¢‘æ ‡ç­¾ä¸­æ‰¾åˆ°æ­Œè¯');
                    }
                    
                    resolve({
                        lyrics: extractedLyrics,
                        title: tag.tags.title,
                        artist: tag.tags.artist,
                        coverUrl: coverUrl
                    });
                },
                onError: function(error) {
                    console.error('è¯»å–æ ‡ç­¾é”™è¯¯:', error.type, error.info);
                    songTitle.textContent = file.name.replace(/\.[^/.]+$/, "");
                    backgroundCover.className = 'background-gradient';
                    resolve({});
                }
            });
        });
    }
    
    // å¤„ç†åµŒå…¥æ­Œè¯
    function processEmbeddedLyrics(lyricsText) {
        if (!lyricsText) return false;
        
        try {
            console.log('å°è¯•å¤„ç†åµŒå…¥æ­Œè¯:', lyricsText.substring(0, 100) + '...');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºLRCæ ¼å¼
            if (lyricsText.includes('[') && /\[\d{2}:\d{2}\.\d{2,3}\]/.test(lyricsText)) {
                console.log('æ£€æµ‹åˆ°LRCæ ¼å¼æ­Œè¯');
                const result = parseLyrics(lyricsText);
                lyrics = result.lyrics;
                
                // åº”ç”¨å…ƒæ•°æ®
                if (result.metadata.ti) songTitle.textContent = result.metadata.ti;
                if (result.metadata.ar) songArtist.textContent = result.metadata.ar;
                
                renderLyrics();
                return true;
            }
            
            // å¦‚æœä¸æ˜¯LRCæ ¼å¼ï¼Œå°è¯•åˆ›å»ºç®€å•çš„æ—¶é—´è½´
            const lines = lyricsText.split('\n').filter(line => line.trim());
            if (lines.length > 0) {
                console.log('åˆ›å»ºç®€å•æ—¶é—´è½´ï¼Œè¡Œæ•°:', lines.length);
                // ä¼°ç®—æ¯è¡Œæ—¶é•¿ï¼Œå‡è®¾æ•´é¦–æ­Œçš„æ—¶é•¿å¹³å‡åˆ†é…ç»™æ¯è¡Œæ­Œè¯
                const avgDuration = audio.duration / lines.length;
                
                lyrics = lines.map((line, index) => ({
                    time: index * avgDuration,
                    text: line.trim()
                }));
                
                renderLyrics();
                return true;
            }
        } catch (e) {
            console.error('å¤„ç†åµŒå…¥æ­Œè¯é”™è¯¯:', e);
        }
        
        return false;
    }
    
    
    // æ£€æµ‹æ–‡ä»¶ç¼–ç 
    async function detectAndReadEncoding(file) {
        // å°è¯•UTF-8ç¼–ç 
        try {
            const text = await readFileAsText(file, 'utf-8');
            if (isValidLyrics(text)) {
                processLyrics(text);
                return;
            }
        } catch (e) {
            console.log('UTF-8ç¼–ç è¯»å–å¤±è´¥');
        }
        
        // å°è¯•GBKç¼–ç 
        try {
            if ('TextDecoder' in window) {
                const buffer = await file.arrayBuffer();
                try {
                    // å°è¯•ä½¿ç”¨GBKç¼–ç 
                    const decoder = new TextDecoder('gbk');
                    const text = decoder.decode(buffer);
                    if (isValidLyrics(text)) {
                        processLyrics(text);
                        return;
                    }
                } catch (e) {
                    console.log('GBKç¼–ç è§£ç å¤±è´¥');
                }
            }
        } catch (e) {
            console.log('GBKç¼–ç è¯»å–å¤±è´¥');
        }
        
        // æ‰€æœ‰ç¼–ç éƒ½å¤±è´¥
        lyricsContainer.innerHTML = '<div class="no-lyrics">æ— æ³•æ­£ç¡®è§£ææ­Œè¯æ–‡ä»¶ç¼–ç </div>';
    }
    
    // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦ä¸ºæœ‰æ•ˆæ­Œè¯
    function isValidLyrics(text) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¹±ç å­—ç¬¦
        if (/[\uFFFD\u0000-\u0008\u000B-\u000C\u000E-\u001F]/.test(text)) {
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºLRCæ ¼å¼æˆ–åŒ…å«ä¸­æ–‡
        return /\[\d{2}:\d{2}\.\d{2,3}\]/.test(text) || /[\u4E00-\u9FFF]/.test(text);
    }
    
    // è¯»å–æ–‡ä»¶ä¸ºæ–‡æœ¬
    function readFileAsText(file, encoding) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file, encoding);
        });
    }
    
    // å¤„ç†æ­Œè¯æ–‡æœ¬
    function processLyrics(text) {
        try {
            const result = parseLyrics(text);
            lyrics = result.lyrics;
            
            // åº”ç”¨å…ƒæ•°æ®
            if (result.metadata.ti) songTitle.textContent = result.metadata.ti;
            if (result.metadata.ar) songArtist.textContent = result.metadata.ar;
            
            renderLyrics();
        } catch (e) {
            console.error('æ­Œè¯å¤„ç†é”™è¯¯:', e);
            lyricsContainer.innerHTML = '<div class="no-lyrics">æ­Œè¯æ ¼å¼è§£æé”™è¯¯</div>';
        }
    }
    // é€šç”¨æ–‡ä»¶å¯¼å…¥å¤„ç†
// ä¿®æ”¹æ–‡ä»¶å¯¼å…¥å¤„ç†ä¸ºæ”¯æŒå¤šæ–‡ä»¶
importFile.addEventListener('change', function() {
    const files = Array.from(this.files);
    if (files.length === 0) return;
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å½“å‰æœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²ï¼Œå¯èƒ½æ˜¯åœ¨ä¸ºå½“å‰æ­Œæ›²æ·»åŠ æ­Œè¯æˆ–å°é¢
    if (files.length === 1 && currentSongIndex !== -1) {
        const file = files[0];
        const fileName = file.name.toLowerCase();
        const fileExt = fileName.split('.').pop();
        
        // åˆ¤æ–­æ–‡ä»¶ç±»å‹
        if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExt) || 
            file.type.startsWith('image/')) {
            // ä¸ºå½“å‰æ­Œæ›²æ·»åŠ /æ›´æ–°å°é¢
            playlist[currentSongIndex].cover = file;
            processCoverFile(file);
            this.value = '';
            return;
        } else if (fileExt === 'lrc' || file.type.startsWith('text/') || ['txt'].includes(fileExt)) {
            // ä¸ºå½“å‰æ­Œæ›²æ·»åŠ /æ›´æ–°æ­Œè¯
            playlist[currentSongIndex].lyrics = file;
            detectAndReadEncoding(file);
            this.value = '';
            return;
        }
        // å¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶åˆ™æŒ‰ç…§æ­£å¸¸æµç¨‹å¤„ç†
    }
    
    // æŒ‰æ–‡ä»¶åå‰ç¼€åˆ†ç»„æ–‡ä»¶ï¼ˆä¸å«æ‰©å±•åçš„éƒ¨åˆ†ï¼‰
    const fileGroups = {};
    
    files.forEach(file => {
        // æå–ä¸å«æ‰©å±•åçš„æ–‡ä»¶åä½œä¸ºæ­Œæ›²ID
        const fileName = file.name;
        const songName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
        
        if (!fileGroups[songName]) {
            fileGroups[songName] = [];
        }
        fileGroups[songName].push(file);
    });
    
    // å¤„ç†æ¯ç»„æ–‡ä»¶
    for (const songName in fileGroups) {
        const songFiles = fileGroups[songName];
        processSongFiles(songName, songFiles);
    }
    
    // æ¸…ç©ºinputï¼Œå…è®¸ç”¨æˆ·å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
    this.value = '';
    
    // æ›´æ–°æ’­æ”¾åˆ—è¡¨UI
    renderPlaylist();
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ æ­Œæ›²ï¼Œè‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¦–
    if (playlist.length > 0 && currentSongIndex === -1) {
        playSong(0);
    }
});
// å¤„ç†ä¸€é¦–æ­Œçš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶
function processSongFiles(songName, files) {
    // åˆ›å»ºæ­Œæ›²å¯¹è±¡
    const song = {
        name: songName,
        audio: null,
        cover: null,
        lyrics: null
    };
    
    // åˆ†ç±»æ–‡ä»¶
    files.forEach(file => {
        const fileName = file.name.toLowerCase();
        const fileExt = fileName.split('.').pop();
        
        if (['mp3', 'm4a', 'wav', 'ogg', 'flac', 'aac', 'alac', 'wma', 'opus'].includes(fileExt) || file.type.startsWith('audio/')) {
            song.audio = file;
        } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExt) || file.type.startsWith('image/')) {
            song.cover = file;
        } else if (fileExt === 'lrc' || file.type.startsWith('text/') || ['txt'].includes(fileExt)) {
            song.lyrics = file;
        }
    });
    
    // åªæœ‰åŒ…å«éŸ³é¢‘æ–‡ä»¶çš„æ‰æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
    if (song.audio) {
        playlist.push(song);
    }
}

// æ¸²æŸ“æ’­æ”¾åˆ—è¡¨UI
// æ¸²æŸ“æ’­æ”¾åˆ—è¡¨UI
function renderPlaylist() {
    playlistElement.innerHTML = '';
    
    playlist.forEach((song, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item' + (index === currentSongIndex ? ' active' : '');
        
        // æ·»åŠ æ­Œæ›²åå®¹å™¨
        const songName = document.createElement('div');
        songName.className = 'song-name';
        songName.textContent = song.name;
        songName.addEventListener('click', () => {
            playSong(index);
        });
        
        // æ·»åŠ åˆ é™¤æŒ‰é’®
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-song';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ­Œæ›²æ’­æ”¾
            removeSong(index);
        });
        
        item.appendChild(songName);
        item.appendChild(removeBtn);
        playlistElement.appendChild(item);
    });
    
    // å¯ç”¨æˆ–ç¦ç”¨ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–æŒ‰é’®
    prevButton.disabled = playlist.length <= 1 || currentSongIndex <= 0;
    nextButton.disabled = playlist.length <= 1 || currentSongIndex >= playlist.length - 1;
}
// ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤æ­Œæ›²
// ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤æ­Œæ›²
function removeSong(index) {
    // å¦‚æœè¦åˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²
    if (index === currentSongIndex) {
        // å¦‚æœè¿™æ˜¯æœ€åä¸€é¦–æ­Œæ›²
        if (playlist.length === 1) {
            // åœæ­¢æ’­æ”¾å¹¶æ¸…é™¤æ’­æ”¾å™¨çŠ¶æ€
            audio.pause();
            audio.src = '';
            playButton.textContent = 'â–¶';
            progressBar.style.width = '0%';
            currentTime.textContent = '00:00';
            totalTime.textContent = '00:00';
            songTitle.textContent = 'æœªåŠ è½½æ­Œæ›²';
            songArtist.textContent = 'æœªçŸ¥è‰ºæœ¯å®¶';
            coverImage.innerHTML = '<div class="cover-placeholder">â™«</div>';
            backgroundCover.className = 'background-gradient';
            lyricsContainer.innerHTML = '<div class="no-lyrics">è¯·å¯¼å…¥æ­Œè¯æ–‡ä»¶...</div>';
            currentSongIndex = -1;
        } else if (index === playlist.length - 1) {
            // å¦‚æœæ˜¯æœ€åä¸€é¦–ï¼Œæ’­æ”¾å‰ä¸€é¦–
            playSong(index - 1);
        } else {
            // å¦åˆ™æ’­æ”¾ä¸‹ä¸€é¦–
            // ä¿æŒå½“å‰çš„ç´¢å¼•å› ä¸ºç§»é™¤åä¸‹ä¸€é¦–ä¼šè‡ªåŠ¨å˜æˆå½“å‰ç´¢å¼•
            currentSongIndex = index;
        }
    } else if (index < currentSongIndex) {
        // å¦‚æœåˆ é™¤çš„æ­Œæ›²åœ¨å½“å‰æ’­æ”¾æ­Œæ›²ä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´å½“å‰ç´¢å¼•
        currentSongIndex--;
    }
    
    // ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤æ­Œæ›²
    playlist.splice(index, 1);
    
    // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨æ˜¯å¦ä¸ºç©º
    if (playlist.length === 0) {
        // é‡ç½®æ‰€æœ‰æ’­æ”¾å™¨çŠ¶æ€å’ŒèƒŒæ™¯
        audio.pause();
        audio.src = '';
        playButton.textContent = 'â–¶';
        progressBar.style.width = '0%';
        currentTime.textContent = '00:00';
        totalTime.textContent = '00:00';
        songTitle.textContent = 'æœªåŠ è½½æ­Œæ›²';
        songArtist.textContent = 'æœªçŸ¥è‰ºæœ¯å®¶';
        coverImage.innerHTML = '<div class="cover-placeholder">â™«</div>';
        lyricsContainer.innerHTML = '<div class="no-lyrics">è¯·å¯¼å…¥æ­Œè¯æ–‡ä»¶...</div>';
                // ç¡®ä¿é‡ç½®èƒŒæ™¯ä¸ºæ¸å˜èƒŒæ™¯
                backgroundCover.className = 'background-gradient';
        backgroundCover.style.backgroundImage = '';
        currentSongIndex = -1;
    } else if (playlist.length > 0 && index === currentSongIndex && index < playlist.length) {
        // å¦‚æœåˆ é™¤åä»æœ‰æ­Œæ›²ï¼Œä¸”å½“å‰ç´¢å¼•æœªæ”¹å˜ï¼Œæ’­æ”¾å½“å‰ç´¢å¼•çš„æ­Œæ›²
        playSong(index);
    }
    
        // é‡æ–°æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        renderPlaylist();
        return;
}



// æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›²
function playSong(index) {
    if (index < 0 || index >= playlist.length) return;
    
    // åœæ­¢å½“å‰æ’­æ”¾
    audio.pause();
    audio.src = '';
    
    // æ›´æ–°å½“å‰ç´¢å¼•
    currentSongIndex = index;
    const song = playlist[index];
    
    // æ ‡è®°å½“å‰æ’­æ”¾çš„æ­Œæ›²
    document.querySelectorAll('.playlist-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });
    
    // é‡ç½®UIå…ƒç´ ï¼Œç¡®ä¿å…ˆå‰çš„çŠ¶æ€ä¸ä¼šå½±å“æ–°çš„æ­Œæ›²
    lyricsContainer.innerHTML = '<div class="no-lyrics">æ­£åœ¨åŠ è½½...</div>';
    
    // å¤„ç†å°é¢æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
    if (song.cover) {
        processCoverFile(song.cover);
    } else {
        // æ²¡æœ‰å•ç‹¬çš„å°é¢æ–‡ä»¶ï¼Œå…ˆè®¾ç½®ä¸ºæ¸å˜èƒŒæ™¯å’Œé»˜è®¤å ä½ç¬¦
        // åç»­åœ¨processAudioFileä¸­å¦‚æœæ‰¾åˆ°å°é¢ä¼šæ›´æ–°
        coverImage.innerHTML = '<div class="cover-placeholder">â™«</div>';
        backgroundCover.className = 'background-gradient';
        backgroundCover.style.backgroundImage = '';
    }
    
    // å¤„ç†æ­Œè¯æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
    if (song.lyrics) {
        detectAndReadEncoding(song.lyrics);
    }
    
    // æœ€åå¤„ç†éŸ³é¢‘æ–‡ä»¶
    if (song.audio) {
        processAudioFile(song.audio);
    }
    
    // å¯ç”¨æˆ–ç¦ç”¨ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–æŒ‰é’®
    prevButton.disabled = index <= 0;
    nextButton.disabled = index >= playlist.length - 1;
}


// å¤„ç†éŸ³é¢‘æ–‡ä»¶å‡½æ•°
// ä¿®æ”¹processAudioFileå‡½æ•°ä»¥å¤„ç†å…ƒæ•°æ®
function processAudioFile(file) {
    // è®¾ç½®éŸ³é¢‘æº
    const fileURL = URL.createObjectURL(file);
    audio.src = fileURL;
    
    // é‡ç½®æ’­æ”¾çŠ¶æ€
    playButton.textContent = 'â–¶';
    progressBar.style.width = '0%';
    currentTime.textContent = '00:00';
    
    // æ˜¯å¦æœ‰å•ç‹¬çš„æ­Œè¯æ–‡ä»¶
    const hasExternalLyrics = playlist[currentSongIndex].lyrics !== null;
    const hasExternalCover = playlist[currentSongIndex].cover !== null;
    
    // åªæœ‰åœ¨æ²¡æœ‰å•ç‹¬æ­Œè¯æ–‡ä»¶æ—¶æ‰æ˜¾ç¤ºåŠ è½½æç¤º
    if (!hasExternalLyrics) {
        lyricsContainer.innerHTML = '<div class="no-lyrics">æ­£åœ¨åŠ è½½æ­Œè¯...</div>';
    }
    
    // åŠ è½½éŸ³é¢‘å…ƒæ•°æ®
    audio.onloadedmetadata = async function() {
        totalTime.textContent = formatTime(audio.duration);
        
        // æå–å…ƒæ•°æ®å’Œæ­Œè¯
        const metadata = await extractMetadata(file);
        
        // æ›´æ–°æ’­æ”¾å™¨æ˜¾ç¤º
        songTitle.textContent = metadata.title || playlist[currentSongIndex].name;
        songArtist.textContent = metadata.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        
        // åªæœ‰åœ¨æ²¡æœ‰å•ç‹¬æ­Œè¯æ–‡ä»¶æ—¶æ‰å°è¯•ä½¿ç”¨åµŒå…¥çš„æ­Œè¯
        if (!hasExternalLyrics) {
            if (metadata.lyrics) {
                const lyricsProcessed = processEmbeddedLyrics(metadata.lyrics);
                if (lyricsProcessed) {
                    console.log('æˆåŠŸå¤„ç†åµŒå…¥æ­Œè¯');
                } else {
                    console.log('åµŒå…¥æ­Œè¯å¤„ç†å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸å…¼å®¹');
                    lyricsContainer.innerHTML = '<div class="no-lyrics">æœªèƒ½è§£æåµŒå…¥æ­Œè¯ï¼Œè¯·å¯¼å…¥æ­Œè¯æ–‡ä»¶</div>';
                }
            } else {
                lyricsContainer.innerHTML = '<div class="no-lyrics">æœªåœ¨éŸ³é¢‘æ–‡ä»¶ä¸­æ‰¾åˆ°æ­Œè¯ï¼Œè¯·å¯¼å…¥æ­Œè¯æ–‡ä»¶</div>';
            }
        }
        
        // åªæœ‰åœ¨æ²¡æœ‰å•ç‹¬çš„å°é¢æ–‡ä»¶æ—¶æ‰ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„å°é¢
        if (!hasExternalCover) {
            if (metadata.coverUrl) {
                // æ›´æ–°æ’­æ”¾å™¨å°é¢
                coverImage.innerHTML = ''; // æ¸…é™¤å ä½ç¬¦
                const img = document.createElement('img');
                img.src = metadata.coverUrl;
                img.className = 'cover-image';
                coverImage.appendChild(img);
                
                // æ›´æ–°èƒŒæ™¯
                backgroundCover.className = 'background-cover-image';
                backgroundCover.style.backgroundImage = `url(${metadata.coverUrl})`;
            } else {
                // æ²¡æœ‰å°é¢å›¾ç‰‡ï¼Œä½¿ç”¨æ¸å˜èƒŒæ™¯
                coverImage.innerHTML = '<div class="cover-placeholder">â™«</div>';
                backgroundCover.className = 'background-gradient';
                backgroundCover.style.backgroundImage = '';
            }
        }
        
        // è‡ªåŠ¨æ’­æ”¾
        audio.play().then(() => {
            playButton.textContent = 'â¸';
        }).catch(err => {
            console.error('æ’­æ”¾å¤±è´¥:', err);
            playButton.textContent = 'â–¶';
        });
    };
}



// å¤„ç†å°é¢å›¾ç‰‡å‡½æ•°
function processCoverFile(file) {
    // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ ¼å¼
    if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // åˆ›å»ºå¯¹è±¡URL
    const coverUrl = URL.createObjectURL(file);
    
    // æ›´æ–°æ’­æ”¾å™¨å°é¢
    coverImage.innerHTML = ''; // æ¸…é™¤å ä½ç¬¦
    const img = document.createElement('img');
    img.src = coverUrl;
    img.className = 'cover-image';
    coverImage.appendChild(img);
    
    // æ›´æ–°èƒŒæ™¯
    backgroundCover.className = 'background-cover-image';
    backgroundCover.style.backgroundImage = `url(${coverUrl})`;
    
    // å¦‚æœå½“å‰æœ‰æ’­æ”¾çš„æ­Œæ›²ï¼Œæ›´æ–°å…¶å°é¢
    if (currentSongIndex !== -1) {
        playlist[currentSongIndex].cover = file;
    }
}

// æ’­æ”¾æ§åˆ¶ï¼ˆä¿æŒä¸å˜ï¼‰
playButton.addEventListener('click', function() {
    if (audio.paused) {
        audio.play().then(() => {
            playButton.textContent = 'â¸';
        }).catch(err => {
            console.error('æ’­æ”¾å¤±è´¥:', err);
            playButton.textContent = 'â–¶';
        });
    } else {
        audio.pause();
        playButton.textContent = 'â–¶';
    }
});

// ä¿®æ”¹ä¸Šä¸€é¦–æŒ‰é’®äº‹ä»¶
prevButton.addEventListener('click', function() {
    if (currentSongIndex > 0) {
        playSong(currentSongIndex - 1);
    }
});

// ä¿®æ”¹ä¸‹ä¸€é¦–æŒ‰é’®äº‹ä»¶
nextButton.addEventListener('click', function() {
    if (currentSongIndex < playlist.length - 1) {
        playSong(currentSongIndex + 1);
    }
});

    
    // è¿›åº¦æ§åˆ¶
    progressContainer.addEventListener('click', function(e) {
        if (audio.duration) {
            const position = e.offsetX / this.clientWidth;
            audio.currentTime = position * audio.duration;
        }
    });
    
    // éŸ³é‡æ§åˆ¶
    volumeSlider.addEventListener('input', function() {
        audio.volume = this.value;
    });
    
    // éŸ³é¢‘äº‹ä»¶
    audio.addEventListener('timeupdate', function() {
        // æ›´æ–°è¿›åº¦æ¡
        if (audio.duration) {
            const percentage = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = `${percentage}%`;
            currentTime.textContent = formatTime(audio.currentTime);
            
            // æ›´æ–°æ­Œè¯åŒæ­¥
            updateLyrics(audio.currentTime);
        }
    });
    
// æ·»åŠ æ­Œæ›²ç»“æŸè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
audio.addEventListener('ended', function() {
    if (currentSongIndex < playlist.length - 1) {
        playSong(currentSongIndex + 1);
    } else {
        // åˆ—è¡¨æ’­æ”¾å®Œæ¯•
        playButton.textContent = 'â–¶';
        progressBar.style.width = '0%';
    }
});
});
    </script>
</body>
</html>